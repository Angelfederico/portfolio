name: expose-rdp-via-cloudflared
on: [workflow_dispatch]

jobs:
  expose-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP and firewall
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0 -Force
          Restart-Service -Name TermService -Force
          netsh advfirewall firewall add rule name="Allow-RDP-Local" dir=in action=allow protocol=TCP localport=3389

      - name: Install cloudflared
        shell: powershell
        run: |
          $exe = Join-Path $env:ProgramFiles "cloudflared\cloudflared.exe"
          New-Item -ItemType Directory -Force -Path (Split-Path $exe) | Out-Null
          Invoke-WebRequest "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile $exe -UseBasicParsing

      - name: Launch cloudflared TCP tunnel to RDP
        shell: powershell
        run: |
          $exe = Join-Path $env:ProgramFiles "cloudflared\cloudflared.exe"
          $log = Join-Path $env:TEMP "cloudflared-rdp.log"
          # Ejecutar en background con Start-Job y volcar salida a logfile
          Start-Job -Name cf-rdp -ScriptBlock {
            param($exePath,$logPath)
            & $exePath tunnel --url "tcp://localhost:3389" *>&1 | Out-File -FilePath $logPath -Encoding utf8 -Append
          } -ArgumentList $exe,$log | Out-Null

          # Esperar y buscar hostname p√∫blico (puede tardar)
          $public = $null
          for ($i=0; $i -lt 60; $i++) {
            if (Test-Path $log) {
              $txt = Get-Content $log -Raw -ErrorAction SilentlyContinue
              $m = [regex]::Match($txt, '(tcp:\/\/[^\s]+|https?:\/\/[^\s]+)', 'IgnoreCase')
              if ($m.Success) { $public = $m.Groups[0].Value; break }
            }
            Start-Sleep -Seconds 2
          }
          if (-not $public) { Write-Error "No public endpoint found in cloudflared log"; exit 1 }
          Write-Host "PUBLIC_ENDPOINT=$public"
          Add-Content -Path $env:GITHUB_ENV -Value ("PUBLIC_ENDPOINT=" + $public)

      - name: Keep alive
        shell: powershell
        run: |
          Write-Host "Tunnel active at $env:PUBLIC_ENDPOINT"
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Still running..."
          }
