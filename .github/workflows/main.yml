name: HTTP via Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  http-cloudflare:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Prepare simple web content
        shell: powershell
        run: |
          $www = Join-Path $env:TEMP "cf-http-site"
          if (Test-Path $www) { Remove-Item -Recurse -Force $www }
          New-Item -ItemType Directory -Path $www | Out-Null
          $index = Join-Path $www "index.html"
          @"
          <!doctype html>
          <html>
          <head><meta charset='utf-8'><title>Cloudflared Test</title></head>
          <body>
            <h1>Servidor HTTP local expuesto por Cloudflare Tunnel</h1>
            <p>Instancia de prueba en el runner GitHub Actions.</p>
            <p>Timestamp: $(Get-Date -Format o)</p>
          </body>
          </html>
          "@ | Out-File -FilePath $index -Encoding utf8

          Write-Host "Web content created at $www"
          # Guardamos la ruta para el siguiente paso
          Add-Content -Path $env:GITHUB_ENV -Value ("WEBROOT=" + $www)

      - name: Start local HTTP server (python) in background
        shell: powershell
        run: |
          $www = $env:WEBROOT
          if (-not $www) { Write-Error "WEBROOT not set"; exit 1 }
          $log = Join-Path $env:TEMP "http-server.log"
          if (Test-Path $log) { Remove-Item $log -Force -ErrorAction SilentlyContinue }

          Write-Host "Starting Python HTTP server serving $www on port 8080 ..."
          # Start a background job that runs python -m http.server 8080 in that directory and redirects output to log
          Start-Job -Name "http-server" -ScriptBlock {
            param($site, $logPath)
            Set-Location $site
            # Ejecutar el servidor (stdout+stderr a logfile)
            python -m http.server 8080 *>&1 | Out-File -FilePath $logPath -Encoding utf8 -Append
          } -ArgumentList $www, $log | Out-Null

          # Esperar un poco y comprobar que el job existe
          Start-Sleep -Seconds 3
          $job = Get-Job -Name "http-server" -ErrorAction SilentlyContinue
          if (-not $job) {
            Write-Error "No se pudo iniciar el servidor HTTP (job no encontrado). Revisa que python esté disponible."
            exit 1
          }
          Write-Host "HTTP server started as job id $($job.Id). Log: $log"
          Add-Content -Path $env:GITHUB_ENV -Value ("HTTP_SERVER_LOG=" + $log)

      - name: Install cloudflared
        shell: powershell
        run: |
          $downloadUrl = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
          $installDir = Join-Path $env:ProgramFiles "cloudflared"
          New-Item -ItemType Directory -Force -Path $installDir | Out-Null
          $exePath = Join-Path $installDir "cloudflared.exe"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $exePath -UseBasicParsing -ErrorAction Stop
          if (-not (Test-Path $exePath)) {
            Write-Error "cloudflared download failed"
            exit 1
          }
          Write-Host "cloudflared installed to $exePath"
          Add-Content -Path $env:GITHUB_ENV -Value ("CLOUDFLARED_EXE=" + $exePath)

      - name: Launch cloudflared tunnel to http://localhost:8080 (background)
        id: launch-tunnel
        shell: powershell
        run: |
          $exe = $env:CLOUDFLARED_EXE
          if (-not $exe -or -not (Test-Path $exe)) {
            Write-Error "cloudflared executable not found at $exe"
            exit 1
          }

          $log = Join-Path $env:TEMP ("cloudflared-" + $env:GITHUB_RUN_ID + ".log")
          if (Test-Path $log) { Remove-Item $log -Force -ErrorAction SilentlyContinue }

          Write-Host "Starting cloudflared tunnel to http://localhost:8080 in background job..."
          Start-Job -Name "cf-tunnel-$($env:GITHUB_RUN_ID)" -ScriptBlock {
            param($exePath, $logPath)
            & $exePath tunnel --url "http://localhost:8080" *>&1 | Out-File -FilePath $logPath -Encoding utf8 -Append
          } -ArgumentList $exe, $log | Out-Null

          # Esperar y buscar la URL pública .trycloudflare.com en el logfile
          $tunnelUrl = $null
          $maxTries = 90        # más paciencia por si tarda en establecerse
          for ($i=0; $i -lt $maxTries; $i++) {
            if (Test-Path $log) {
              $txt = Get-Content $log -Raw -ErrorAction SilentlyContinue
              if ($txt) {
                # buscar una URL trycloudflare (o cualquier https) para mayor robustez
                $m = [regex]::Match($txt, '(https?:\/\/[A-Za-z0-9\-\._]+\.trycloudflare\.com[^\s]*)', 'IgnoreCase')
                if (-not $m.Success) {
                  $m = [regex]::Match($txt, '(https?:\/\/[^\s"<>]+)', 'IgnoreCase')
                }
                if ($m.Success) {
                  $tunnelUrl = $m.Groups[1].Value.Trim()
                  # Descartar enlaces claramente no relacionados (e.g., cloudflare docs)
                  if ($tunnelUrl -match 'cloudflare\.com\/(website-terms|docs|privacy|legal)') {
                    $tunnelUrl = $null
                  } else {
                    break
                  }
                }
              }
            }
            Start-Sleep -Seconds 2
          }

          if (-not $tunnelUrl) {
            Write-Host "No se detectó URL pública en la salida de cloudflared. Últimas líneas del log:"
            if (Test-Path $log) { Get-Content $log -Tail 200 } else { Write-Host "No log produced." }
            Write-Error "Fallo al obtener URL pública del túnel."
            exit 1
          }

          Write-Host "Detected tunnel URL: $tunnelUrl"
          Add-Content -Path $env:GITHUB_ENV -Value ("CLOUDFLARE_URL=" + $tunnelUrl)
          # guardar id job para debug
          $job = Get-Job -Name "cf-tunnel-$($env:GITHUB_RUN_ID)" -ErrorAction SilentlyContinue
          if ($job) { Add-Content -Path $env:GITHUB_ENV -Value ("CLOUDFLARE_JOB_ID=" + $job.Id) }

      - name: Show connection info & keep alive
        shell: powershell
        run: |
          Write-Host "`n=== HTTP via Cloudflare Tunnel ==="
          Write-Host "URL pública (abrir en navegador): $env:CLOUDFLARE_URL"
          Write-Host "Servidor local: http://localhost:8080"
          Write-Host "Contenido servido desde: $env:WEBROOT"
          Write-Host "==================================="

          Write-Host "`n(Para cerrar el acceso: cancelar el workflow en GitHub Actions.)`n"

          while ($true) {
            Write-Host "[$(Get-Date -Format o)] Tunnel active at $env:CLOUDFLARE_URL"
            Start-Sleep -Seconds 300
          }
