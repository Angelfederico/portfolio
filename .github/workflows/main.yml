name: HTTP via Cloudflare Tunnel (Fixed)

on:
  workflow_dispatch:

jobs:
  http-cloudflare:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Create simple website
        shell: powershell
        run: |
          $webroot = Join-Path $env:TEMP "cf-site"
          if (Test-Path $webroot) { Remove-Item -Recurse -Force $webroot }
          New-Item -ItemType Directory -Force -Path $webroot | Out-Null
          @"
          <html><head><meta charset='utf-8'><title>Cloudflare Tunnel Test</title></head>
          <body>
          <h1>Servidor HTTP activo dentro de GitHub Actions</h1>
          <p>Prueba funcionando - $(Get-Date)</p>
          </body></html>
          "@ | Out-File (Join-Path $webroot "index.html") -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value ("WEBROOT=" + $webroot)
          Write-Host "Webroot creado en:" $webroot

      - name: Start local HTTP server
        shell: powershell
        run: |
          $www = $env:WEBROOT
          if (-not $www) { Write-Error "WEBROOT no establecido"; exit 1 }
          $log = Join-Path $env:TEMP "http-server.log"
          if (Test-Path $log) { Remove-Item $log -Force -ErrorAction SilentlyContinue }
          Write-Host "Iniciando servidor HTTP en el puerto 8080..."
          Start-Job -Name "http" -ScriptBlock {
            param($dir,$logpath)
            Set-Location $dir
            # Ejecuta el servidor; redirige salida a logfile
            python -m http.server 8080 *>&1 | Out-File -FilePath $logpath -Encoding utf8 -Append
          } -ArgumentList $www,$log | Out-Null
          Start-Sleep -Seconds 5
          $conn = Test-NetConnection -ComputerName localhost -Port 8080 -WarningAction SilentlyContinue
          if (-not $conn.TcpTestSucceeded) {
            Write-Error "El servidor HTTP no está escuchando en el puerto 8080"
            if (Test-Path $log) { Write-Host "Últimas líneas del log HTTP:"; Get-Content $log -Tail 50 }
            exit 1
          }
          Write-Host "Servidor HTTP arrancado correctamente."
          Add-Content -Path $env:GITHUB_ENV -Value ("HTTP_LOG=" + $log)

      - name: Install cloudflared
        shell: powershell
        run: |
          $url = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
          $path = Join-Path $env:ProgramFiles "cloudflared"
          New-Item -ItemType Directory -Force -Path $path | Out-Null
          $exe = Join-Path $path "cloudflared.exe"
          Invoke-WebRequest -Uri $url -OutFile $exe -UseBasicParsing -ErrorAction Stop
          if (-not (Test-Path $exe)) {
            Write-Error "cloudflared no se pudo descargar"
            exit 1
          }
          Write-Host "cloudflared instalado en:" $exe
          Add-Content -Path $env:GITHUB_ENV -Value ("CLOUDFLARED_EXE=" + $exe)

      - name: Launch Cloudflare Tunnel (background)
        shell: powershell
        run: |
          $exe = $env:CLOUDFLARED_EXE
          if (-not $exe -or -not (Test-Path $exe)) { Write-Error "cloudflared no encontrado"; exit 1 }
          $log = Join-Path $env:TEMP "cloudflared.log"
          if (Test-Path $log) { Remove-Item $log -Force -ErrorAction SilentlyContinue }

          Write-Host "Lanzando cloudflared tunnel a http://localhost:8080 en background..."
          Start-Job -Name "cf" -ScriptBlock {
            param($exePath,$logPath)
            & $exePath tunnel --url "http://localhost:8080" *>&1 | Out-File -FilePath $logPath -Encoding utf8 -Append
          } -ArgumentList $exe,$log | Out-Null

          Write-Host "Esperando la URL pública del túnel..."
          $tunnelUrl = $null
          $max = 90
          for ($i=0; $i -lt $max; $i++) {
            if (Test-Path $log) {
              $txt = Get-Content $log -Raw -ErrorAction SilentlyContinue
              if ($txt) {
                $m = [regex]::Match($txt, '(https?:\/\/[A-Za-z0-9\-]+\.trycloudflare\.com[^\s]*)', 'IgnoreCase')
                if ($m.Success) {
                  $candidate = $m.Groups[1].Value.Trim()
                  # descartar enlaces obvios a docs/terms
                  if ($candidate -notmatch 'cloudflare\.com\/(website-terms|docs|privacy|legal)') {
                    $tunnelUrl = $candidate
                    break
                  }
                }
              }
            }
            Start-Sleep -Seconds 2
          }

          if (-not $tunnelUrl) {
            Write-Host "No se detectó URL pública. Últimas líneas del log cloudflared:"
            if (Test-Path $log) { Get-Content $log -Tail 200 } else { Write-Host "No se ha producido log aún." }
            exit 1
          }

          Write-Host "Tunnel URL detectada:" $tunnelUrl
          Add-Content -Path $env:GITHUB_ENV -Value ("TUNNEL_URL=" + $tunnelUrl)
          # guardar job id para debug
          $job = Get-Job -Name "cf" -ErrorAction SilentlyContinue
          if ($job) { Add-Content -Path $env:GITHUB_ENV -Value ("CLOUDFLARED_JOB_ID=" + $job.Id) }

      - name: Show info & keep alive
        shell: powershell
        run: |
          Write-Host "===================================="
          Write-Host "Tunnel URL:" $env:TUNNEL_URL
          Write-Host "Serving (local):" $env:WEBROOT
          Write-Host "HTTP log:" $env:HTTP_LOG
          Write-Host "cloudflared log: $env:TEMP\cloudflared.log"
          Write-Host "===================================="
          Write-Host "El túnel y servidor están activos. Para cerrarlo: cancelar el workflow."
          while ($true) {
            Write-Host (Get-Date -Format "yyyy-MM-ddTHH:mm:ssK") " - still running..."
            Start-Sleep -Seconds 300
          }
