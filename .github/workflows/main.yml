name: HTTP via Cloudflare Tunnel (Stable)

on:
  workflow_dispatch:

jobs:
  http-cloudflare:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Create simple website
        shell: powershell
        run: |
          $webroot = Join-Path $env:TEMP "cf-site"
          if (Test-Path $webroot) { Remove-Item -Recurse -Force $webroot }
          New-Item -ItemType Directory -Force -Path $webroot | Out-Null
          @"
          <html><head><meta charset='utf-8'><title>Cloudflare Tunnel Test</title></head>
          <body>
          <h1>Servidor HTTP activo dentro de GitHub Actions</h1>
          <p>Prueba funcionando - $(Get-Date)</p>
          </body></html>
          "@ | Out-File (Join-Path $webroot "index.html") -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value ("WEBROOT=" + $webroot)

      - name: Start local HTTP server
        shell: powershell
        run: |
          $www = $env:WEBROOT
          $log = Join-Path $env:TEMP "http-server.log"
          Write-Host "Starting HTTP server on port 8080..."
          Start-Job -Name "http" -ScriptBlock {
            param($dir,$logpath)
            Set-Location $dir
            python -m http.server 8080 *>&1 | Out-File -FilePath $logpath -Encoding utf8 -Append
          } -ArgumentList $www,$log | Out-Null
          Start-Sleep -Seconds 5
          if (-not (Test-NetConnection -ComputerName localhost -Port 8080).TcpTestSucceeded) {
            Write-Error "El servidor HTTP no est√° escuchando en el puerto 8080"
            exit 1
          }
          Write-Host "HTTP server running OK."
          Add-Content -Path $env:GITHUB_ENV -Value ("HTTP_LOG=" + $log)

      - name: Install cloudflared
        shell: powershell
        run: |
          $url = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
          $path = Join-Path $env:ProgramFiles "cloudflared"
          New-Item -ItemType Directory -Force -Path $path | Out-Null
          $exe = Join-Path $path "cloudflared.exe"
          Invoke-WebRequest -Uri $url -OutFile $exe -UseBasicParsing
          Add-Content -Path $env:GITHUB_ENV -Value ("CLOUDFLARED_EXE=" + $exe)

      - name: Launch Cloudflare Tunnel
        shell: powershell
        run: |
          $exe = $env:CLOUDFLARED_EXE
          $log = Join-Path $env:TEMP "cloudflared.log"
          Start-Job -Name "cf" -ScriptBlock {
            param($exe,$log)
            & $exe tunnel --url http://localhost:8080 *>&1 | Out-File -FilePath $log -Encoding utf8 -Append
          } -ArgumentList $exe,$log | Out-Null
          Write-Host "Waiting for tunnel URL..."
          $url = $null
          for ($i=0; $i -lt 60; $i++) {
            if (Test-Path $log) {
              $txt = Get-Content $log -Raw -ErrorAction SilentlyContinue
              $m = [regex]::Match($txt, '(https://[a-zA-Z0-9-]+\.trycloudflare\.com)', 'IgnoreCase')
              if ($m.Success) { $url = $m.Groups[1].Value; break }
            }
            Start-Sleep -Seconds 2
          }
          if (-not $url) { Write-Error "No se detect√≥ URL de t√∫nel"; exit 1 }
          Add-Content -Path $env:GITHUB_ENV -Value ("TUNNEL_URL=" + $url)
          Write-Host "Tunnel URL: $url"

      - name: Keep alive and show info
        shell: powershell
        run: |
          Write-Host "=================================="
          Write-Host "üåç Tunnel URL: $env:TUNNEL_URL"
          Write-Host "üìÇ Serving: $env:WEBROOT"
          Write-Host "=================================="
          Write-Host "Manteniendo el t√∫nel activo..."
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "[$(Get-Date -Format T)] still running..."
          }
