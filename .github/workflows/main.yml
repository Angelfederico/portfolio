name: RDP via Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  secure-rdp-cloudflare:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Cloudflare" | Out-Null
          netsh advfirewall firewall add rule name="RDP-Cloudflare" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Secure Password
        shell: powershell
        run: |
          Add-Type -AssemblyName System.Security
          $upper = [char[]](65..90)
          $lower = [char[]](97..122)
          $number = [char[]](48..57)
          $special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
          $raw = @()
          $raw += $upper | Get-Random -Count 3
          $raw += $lower | Get-Random -Count 3
          $raw += $number | Get-Random -Count 3
          $raw += $special | Get-Random -Count 3
          $password = -join ($raw | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          if (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue) {
              Set-LocalUser -Name "RDP" -Password $securePass
          } else {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          }
          
          Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction SilentlyContinue
          
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          Write-Host "User RDP created with password: $password"

      - name: Install cloudflared (Cloudflare Tunnel)
        shell: powershell
        run: |
          $url = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
          $path = "$env:ProgramFiles\cloudflared"
          New-Item -ItemType Directory -Force -Path $path | Out-Null
          $exe = Join-Path $path "cloudflared.exe"
          Invoke-WebRequest -Uri $url -OutFile $exe -UseBasicParsing
          Write-Host "cloudflared installed at $exe"

      - name: Launch ephemeral Cloudflare tunnel
        shell: powershell
        run: |
          $exe = "$env:ProgramFiles\cloudflared\cloudflared.exe"
          Write-Host "Starting cloudflared tunnel to rdp://localhost:3389 ..."
          $log = "$env:TEMP\cloudflared.log"
          Start-Process -FilePath $exe -ArgumentList "tunnel","--url","rdp://localhost:3389" -RedirectStandardOutput $log -RedirectStandardError $log
          
          $url = $null
          for ($i=0; $i -lt 30; $i++) {
              if (Test-Path $log) {
                  $content = Get-Content $log -Raw
                  if ($content -match "https://[-a-z0-9.]+trycloudflare.com") {
                      $url = $Matches[0]
                      break
                  }
              }
              Start-Sleep -Seconds 2
          }

          if (-not $url) {
              Write-Error "No Cloudflare URL found."
              exit 1
          }

          echo "CLOUDFLARE_TUNNEL_URL=$url" >> $env:GITHUB_ENV
          Write-Host "Cloudflare Tunnel URL: $url"

      - name: Show connection info & keep alive
        shell: powershell
        run: |
          Write-Host "=== RDP via Cloudflare Tunnel ==="
          Write-Host "URL: $env:CLOUDFLARE_TUNNEL_URL"
          Write-Host "Username: RDP"
          Write-Host "Password: $env:RDP_PASSWORD"
          Write-Host "=================================="
          while ($true) {
              Write-Host "[$(Get-Date)] Tunnel active at $env:CLOUDFLARE_TUNNEL_URL"
              Start-Sleep -Seconds 300
          }
